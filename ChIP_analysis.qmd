---
title: "ChIP Analysis"
format: html
editor: visual
---

# 1. Summary

This code covers analysis of transcription factor EB ChIP-seq data.

http://bioconductor.org/packages/devel/bioc/vignettes/ChIPseeker/inst/doc/ChIPseeker.html#abstract https://www.biostars.org/p/274689/ https://hbctraining.github.io/Intro-to-ChIPseq/lessons/05_peak_calling_macs.html

```{r, echo=FALSE, warning=FALSE}
if(!require(tidyverse)){install.packages("tidyverse")}
if(!require(readxl)){install.packages("readxl")}
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
if(!require(GO.db)){BiocManager::install("GO.db")}
if(!require(HDO.db)){BiocManager::install("HDO.db")}
if(!require(clusterProfiler)){BiocManager::install("clusterProfiler")}
if(!require(ChIPseeker)){BiocManager::install("ChIPseeker")}
if(!require(plyranges)){BiocManager::install("plyranges")}
library(ChIPseeker)
library(clusterProfiler)
```

## File conversions

These don't seem to be working.

```{r}
gc()
list.files("data")
Cold_Pol <- readPeakFile("data/ChIP/4-Rpb1-CTD_S14_L001_treat_pileup.bdg")
#head(Cold_Pol)
gc()
write_bed(Cold_Pol, "data/ChIP/4-Rpb1-CTD_S14_L001_treat_pileup.bed", index = F)
```

Maybe I should try the narrow peaks?

```{r}
gc()
list.files("data")
TFEB_Cold <- readPeakFile("data/ChIP/4-Rpb1-CTD_S14_L001_treat_pileup.bed")
```

# Use the annotated peaks file

```{r}
list.files("data")

RT_CTD <- read_xlsx("data/ChIP/4_Rpb1_CTD_peaks_annotated_p.xlsx")
RT_TFEB <- read_xlsx("data/ChIP/4_TFEB_peaks_annotated_p.xlsx")
Cold_CTD <- read_xlsx("data/ChIP/10_Rpb1_CTD_peaks_annotated_p.xlsx")
Cold_TFEB <- read_xlsx("data/ChIP/10_TFEB_peaks_annotated_p.xlsx")
```

```{r}
RT_CTD$Annot_new <- gsub(" .*", "", RT_CTD$Annotation)
RT_TFEB$Annot_new <- gsub(" .*", "", RT_TFEB$Annotation)
RT_only <- merge(RT_CTD, RT_TFEB, by = c("Gene Name", "Annotation"))
RT_only$label_me <- ifelse(RT_only$`Gene Name` == "Pla2g15", T, F)

p0 <- RT_only |> filter(Annot_new.x == "promoter-TSS") |>
  ggplot(aes(log10(`Peak Score.x`), log10(`Peak Score.y`), 
           color = label_me,
           fill = label_me,
           name = `Gene Name`
           )
         ) + geom_point()
plotly::ggplotly(p0)

p0 <- RT_only |> filter(Annot_new.x == "Intergenic") |>
  ggplot(aes(log10(`Peak Score.x`), log10(`Peak Score.y`), 
           color = label_me,
           fill = label_me,
           name = `Gene Name`
           )
         ) + geom_point()
plotly::ggplotly(p0)

### Cold
Cold_CTD$Annot_new <- gsub(" .*", "", Cold_CTD$Annotation)
Cold_TFEB$Annot_new <- gsub(" .*", "", Cold_TFEB$Annotation)
Cold_only <- merge(Cold_CTD, Cold_TFEB, by = c("Gene Name", "Annotation"))
Cold_only$label_me <- ifelse(Cold_only$`Gene Name` == "Pla2g15", T, F)

p0 <- Cold_only |> filter(Annot_new.x == "promoter-TSS") |>
  ggplot(aes(log10(`Peak Score.x`), log10(`Peak Score.y`), 
           color = label_me,
           fill = label_me,
           name = `Gene Name`
           )
         ) + geom_point()
plotly::ggplotly(p0)

p0 <- Cold_only |> filter(Annot_new.x == "Intergenic") |>
  ggplot(aes(log10(`Peak Score.x`), log10(`Peak Score.y`), 
           color = label_me,
           fill = label_me,
           name = `Gene Name`
           )
         ) + geom_point()
plotly::ggplotly(p0)
```
